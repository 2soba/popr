# BUILD redisfab/rejson:{{REDIS_VERSION}}-{{REDIS_ARCH}}-{{REDIS_OSNICK}}

ARG PACK={{REDISAI_PACK}}
ARG TEST={{REDISAI_TEST}}

#----------------------------------------------------------------------------------------------
FROM redisfab/redis:{{REDIS_VERSION}}-{{REDIS_ARCH}}-{{REDIS_OSNICK}} AS builder

ARG PACK
ARG TEST

RUN echo "Building for {{REDIS_OSNICK}} ({{OS}}) for {{REDIS_ARCH}} [with Redis {{REDIS_VERSION}}]"

ADD ./ /build
WORKDIR /build

RUN ./deps/readies/bin/getpy3
RUN ./system-setup.py
RUN bash -l -c make

RUN set -ex ;\
    if [ "$TEST" = "1" ]; then bash -l -c "TEST= make test"; fi
RUN set -ex ;\
    mkdir -p bin/artifacts ;\
    if [ "$PACK" = "1" ]; then bash -l -c "make pack"; fi

#----------------------------------------------------------------------------------------------
FROM redisfab/redis:{{REDIS_VERSION}}-{{REDIS_ARCH}}-{{REDIS_OSNICK}}

ARG REDIS_VER

ENV LIBDIR /usr/lib/redis/modules
WORKDIR /data
RUN mkdir -p "$LIBDIR"

COPY --from=builder /build/bin/artifacts/ /var/opt/redislabs/artifacts
COPY --from=builder /build/target/release/rejson.so "$LIBDIR"

EXPOSE 6379
CMD ["redis-server", "--loadmodule", "/usr/lib/redis/modules/rejson.so"]
